/*
 * SOLAR TRACKER LOGIC (P-CONTROL)
 * Hardware: Keyestudio 3-Pin Module (Widerstand ist intern verbaut)
 * Verkabelung: S -> Analog Pin, V -> 5V, G -> GND
 */

// --- 1. PIN ZUORDNUNG (Kreis-Anordnung) ---
// Oben (12 Uhr)
const int PIN_OBEN   = A0;
// Unten (6 Uhr) - Gegenüber von A0
const int PIN_UNTEN  = A2;

// Links (9 Uhr)
const int PIN_LINKS  = A3;
// Rechts (3 Uhr) - Gegenüber von A3
const int PIN_RECHTS = A1;

// --- 2. P-REGLER EINSTELLUNGEN ---
// Hier stellst du die Empfindlichkeit ein
float Kp = 0.15;       // Verstärkung: 0.15 ist ein guter Mittelwert
int minSchritt = 1;    // Mindestens 1 Grad bewegen (gegen Haftreibung)
int maxSchritt = 5;    // Maximal 5 Grad springen (Sicherheit)
int toleranz   = 40;   // Hysterese: Erst ab Diff > 40 reagieren

// --- 3. STATUS VARIABLES ---
// Startposition in der Mitte
int winkelVertikal   = 90; 
int winkelHorizontal = 90; 

// Sicherheits-Limits für die Servos
const int LIMIT_V_MIN = 20;  
const int LIMIT_V_MAX = 160;
const int LIMIT_H_MIN = 0;
const int LIMIT_H_MAX = 180;

void setup() {
  Serial.begin(9600);
  Serial.println("--- SOLAR TRACKER: P-CONTROL MODUS ---");
}

void loop() {
  // === A. MESSUNG ===
  // Keyestudio Module: Viel Licht = Hoher Wert (meistens)
  int valOben   = analogRead(PIN_OBEN);
  int valUnten  = analogRead(PIN_UNTEN);
  int valLinks  = analogRead(PIN_LINKS);
  int valRechts = analogRead(PIN_RECHTS);

  // === B. LOGIK FÜR VERTIKAL (Hoch/Runter) ===
  int diffVert = valOben - valUnten;
  
  if (abs(diffVert) > toleranz) {
    // 1. P-Regler: Berechne Geschwindigkeit dynamisch
    int speed = abs(diffVert) * Kp;
    
    // 2. Begrenzer (Clamping)
    if (speed < minSchritt) speed = minSchritt;
    if (speed > maxSchritt) speed = maxSchritt;
    
    // 3. Bewegung
    // Falls er falsch herum läuft, tausche hier + und -
    if (valOben > valUnten) {
      winkelVertikal += speed; // Nach Oben schauen
    } else {
      winkelVertikal -= speed; // Nach Unten schauen
    }
  }

  // === C. LOGIK FÜR HORIZONTAL (Links/Rechts) ===
  int diffHoriz = valLinks - valRechts;

  if (abs(diffHoriz) > toleranz) {
    int speed = abs(diffHoriz) * Kp;
    
    if (speed < minSchritt) speed = minSchritt;
    if (speed > maxSchritt) speed = maxSchritt;

    // Falls er falsch herum läuft, tausche hier + und -
    if (valLinks > valRechts) {
      winkelHorizontal -= speed; // Nach Links drehen
    } else {
      winkelHorizontal += speed; // Nach Rechts drehen
    }
  }

  // === D. SICHERHEIT & OUTPUT ===
  // Verhindern, dass der Motor gegen die Wand fährt
  winkelVertikal   = constrain(winkelVertikal, LIMIT_V_MIN, LIMIT_V_MAX);
  winkelHorizontal = constrain(winkelHorizontal, LIMIT_H_MIN, LIMIT_H_MAX);

  // Ausgabe für den Plotter
  Serial.print("Ziel_V:");     Serial.print(winkelVertikal);
  Serial.print("\t"); 
  Serial.print("Ziel_H:");   Serial.println(winkelHorizontal);
  
  delay(50); // Kleines Päuschen für Stabilität
}
