#include <Servo.h>

/*
 * SOLAR TRACKER - SMOOTH EDITION
 * Features: 
 * 1. Hysterese (kein Zittern bei kleinen Wolken)
 * 2. Speed-Limit (Max 5 Grad pro Sekunde)
 */

// --- 1. PIN KONFIGURATION ---
const int PIN_OBEN   = A0; 
const int PIN_UNTEN  = A2; 
const int PIN_LINKS  = A3; 
const int PIN_RECHTS = A1; 

const int PIN_SERVO_HORIZ = 9;  
const int PIN_SERVO_VERT  = 10; 

// --- 2. OBJEKTE ---
Servo servoHorizontal;
Servo servoVertikal;

// --- 3. EINSTELLUNGEN ---

// Hysterese: Je höher der Wert, desto "fauler" ist der Tracker.
// 50-100 ist gut für draußen. Er bewegt sich erst, wenn der Unterschied deutlich ist.
const int TOLERANZ = 100;   

// Geschwindigkeit: 
// Wir bewegen uns immer 1 Grad pro Zyklus.
// Die Pause bestimmt die Geschwindigkeit.
// 200ms Pause = 5 Schritte pro Sekunde (5°/sek)
const int WARTEZEIT = 200; 

// Limits (Mechanischer Schutz)
const int LIMIT_VERT_MIN = 20;   
const int LIMIT_VERT_MAX = 160;
const int LIMIT_HORIZ_MIN = 0;
const int LIMIT_HORIZ_MAX = 180;

// Aktuelle Positionen
int winkelVertikal   = 90; 
int winkelHorizontal = 90; 

void setup() {
  Serial.begin(9600);
  
  servoHorizontal.attach(PIN_SERVO_HORIZ);
  servoVertikal.attach(PIN_SERVO_VERT);

  // Startposition einnehmen
  servoHorizontal.write(winkelHorizontal);
  servoVertikal.write(winkelVertikal);

  Serial.println("--- SOLAR TRACKER (SMOOTH MODE) GESTARTET ---");
}

void loop() {
  // === A. MESSUNG ===
  // Wir lesen die Sensoren
  int valOben   = analogRead(PIN_OBEN);
  int valUnten  = analogRead(PIN_UNTEN);
  int valLinks  = analogRead(PIN_LINKS);
  int valRechts = analogRead(PIN_RECHTS);

  // === B. LOGIK VERTIKAL (Oben/Unten) ===
  int diffVert = valOben - valUnten;
  
  // Hysterese-Check: Nur bewegen, wenn Unterschied > Toleranz
  if (abs(diffVert) > TOLERANZ) {
    
    if (valOben > valUnten) {
      winkelVertikal++;  // Nur 1 Grad Schritt (Langsam!)
    } else {
      winkelVertikal--;  // Nur 1 Grad Schritt
    }
  }

  // === C. LOGIK HORIZONTAL (Links/Rechts) ===
  int diffHoriz = valLinks - valRechts;

  if (abs(diffHoriz) > TOLERANZ) {
    
    if (valLinks > valRechts) {
      winkelHorizontal--; // Nur 1 Grad Schritt
    } else {
      winkelHorizontal++; // Nur 1 Grad Schritt
    }
  }

  // === D. SICHERHEIT (Begrenzungen) ===
  winkelVertikal   = constrain(winkelVertikal, LIMIT_VERT_MIN, LIMIT_VERT_MAX);
  winkelHorizontal = constrain(winkelHorizontal, LIMIT_HORIZ_MIN, LIMIT_HORIZ_MAX);

  // === E. MOTOR UPDATE ===
  servoHorizontal.write(winkelHorizontal);
  servoVertikal.write(winkelVertikal);

  // === F. GESCHWINDIGKEITS-BREMSE ===
  // Hier passiert die Magie für die 5 Grad/Sekunde.
  // Der Arduino macht jetzt 200ms Pause, bevor er wieder misst und sich bewegt.
  delay(WARTEZEIT); 
}
